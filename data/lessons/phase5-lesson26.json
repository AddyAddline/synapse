{
  "phase": 5,
  "order_num": 3,
  "title": "Working with fMRI Data",
  "description": "Load real fMRI brain volumes, extract ROI time series, and correlate brain activity with a task design.",
  "difficulty": "advanced",
  "estimated_minutes": 45,
  "content_md": "# Working with fMRI Data\n\nFunctional MRI (fMRI) measures brain activity by detecting changes in **blood oxygenation**. When neurons in a brain region become active, blood flow to that region increases — this is called the **BOLD response** (Blood Oxygen Level Dependent).\n\n## How fMRI Differs from EEG\n\n| | EEG | fMRI |\n|---|---|---|\n| **Measures** | Electrical activity | Blood oxygenation |\n| **Time resolution** | ~1 ms | ~1-2 seconds |\n| **Spatial resolution** | ~1 cm | ~1-3 mm |\n| **Data format** | Channels × Time | 3D volumes over time |\n\nfMRI gives you a **3D picture of the brain** at each time point. A typical fMRI experiment collects one 3D volume every 1-2 seconds for several minutes.\n\n## The Dataset\n\nThe file `fmri_data.mat` contains task-based fMRI data. This could include:\n- A 4D matrix: X × Y × Z × Time (voxels across time)\n- Or a 2D matrix: Voxels × Time (already reshaped)\n- Task timing information\n- Possibly a design matrix\n\n## Region of Interest (ROI) Analysis\n\nRather than analyzing every voxel in the brain (~100,000+ voxels), we often focus on a **Region of Interest** — a predefined brain area. We extract the average time series from that region and analyze it.\n\n## Percent Signal Change\n\nfMRI BOLD signals are measured in arbitrary units. To make results meaningful, we compute **percent signal change** relative to baseline:\n\n```matlab\npsc = (signal - baseline) / baseline * 100;\n```\n\nA typical BOLD response is 1-5% signal change — tiny but reliable.\n\nLet's explore some real brain imaging data!",
  "exercises": [
    {
      "order_num": 1,
      "title": "Load and inspect fMRI data",
      "prompt": "Load the fMRI dataset and explore its structure.\n\n1. Load fmri_data.mat\n2. Display all field names with class and size (same pattern as previous lessons)\n3. Find the largest numeric field — this is likely the fMRI data\n4. Display its dimensions and the total number of elements\n5. If the data has more than 2 dimensions, display: 'This is a 4D volume: X x Y x Z x Time'\n   If it has 2 dimensions, display: 'This is a 2D matrix: Voxels x Time' (or Time x Voxels based on which is larger)\n6. Display the min, max, and mean of the entire dataset:\n   disp(['Min: ' num2str(min(data_matrix(:)))])\n   disp(['Max: ' num2str(max(data_matrix(:)))])\n   disp(['Mean: ' num2str(mean(data_matrix(:)))])",
      "starter_code": "% Load and inspect real fMRI data\nNEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/fmri_data.mat']);\n\n% Display structure\nfnames = fieldnames(data);\n% YOUR CODE HERE\n\n% Find main data matrix\n% YOUR CODE HERE\n\n% Display dimensionality\n% YOUR CODE HERE\n\n% Display value range\n% YOUR CODE HERE\n",
      "solution": "NEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/fmri_data.mat']);\n\nfnames = fieldnames(data);\ndisp('=== fMRI Data Structure ===');\nfor i = 1:length(fnames)\n  name = fnames{i};\n  val = data.(name);\n  disp([name ' | class: ' class(val) ' | size: ' num2str(size(val))]);\nend\n\nmax_numel = 0;\nfmri_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && numel(val) > max_numel\n    max_numel = numel(val);\n    fmri_field = fnames{i};\n  end\nend\n\nfmri_matrix = data.(fmri_field);\ndisp('');\ndisp(['Main data field: ' fmri_field]);\ndisp(['Dimensions: ' num2str(size(fmri_matrix))]);\ndisp(['Total elements: ' num2str(numel(fmri_matrix))]);\n\nnd = ndims(fmri_matrix);\nif nd > 2\n  disp(['This is a ' num2str(nd) 'D volume: ' num2str(size(fmri_matrix))]);\nelse\n  [r, c] = size(fmri_matrix);\n  if r > c\n    disp(['This is a 2D matrix: ' num2str(r) ' Voxels x ' num2str(c) ' Time']);\n  else\n    disp(['This is a 2D matrix: ' num2str(r) ' Time x ' num2str(c) ' Voxels']);\n  end\nend\n\ndisp('');\ndisp(['Min: ' num2str(min(fmri_matrix(:)))]);\ndisp(['Max: ' num2str(max(fmri_matrix(:)))]);\ndisp(['Mean: ' num2str(mean(fmri_matrix(:)))]);",
      "hints": [
        "Use ndims() to check how many dimensions the data has.",
        "fmri_matrix(:) reshapes any matrix into a column vector — useful for global min/max/mean.",
        "A 4D fMRI volume is typically X×Y×Z×Time where the last dimension is time."
      ],
      "test_cases": [],
      "requires_plot": false
    },
    {
      "order_num": 2,
      "title": "Extract and plot an ROI time series",
      "prompt": "Extract a time series from the fMRI data and visualize it.\n\n1. Load fmri_data.mat and find the main numeric field\n2. Extract a time series:\n   - If data is 4D (X×Y×Z×T): pick the center voxel (round(size/2) for first 3 dims) and extract across time. Also compute mean across a 3×3×3 cube around center.\n   - If data is 2D: extract the first row (or column, whichever is the time dimension — the shorter dimension is typically time)\n3. If the time series has more than 500 points, only use the first 500\n4. Compute percent signal change: psc = (ts - mean(ts)) / mean(ts) * 100\n5. Create a figure with 2 subplots:\n   - Top: raw time series. Title: 'Raw fMRI Time Series'. ylabel: 'Signal (a.u.)'\n   - Bottom: percent signal change. Title: 'Percent Signal Change'. ylabel: '% Change'\n   - Both: xlabel: 'Time Point'\n6. Main title: 'fMRI ROI Time Series'",
      "starter_code": "% Extract ROI time series from fMRI data\nNEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/fmri_data.mat']);\n\n% Find main data field\nfnames = fieldnames(data);\nmax_numel = 0; fmri_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && numel(val) > max_numel\n    max_numel = numel(val); fmri_field = fnames{i};\n  end\nend\nfmri = data.(fmri_field);\n\n% Extract time series based on dimensionality\n% YOUR CODE HERE\n\n% Truncate if needed\n% YOUR CODE HERE\n\n% Compute percent signal change\n% YOUR CODE HERE\n\n% Plot\nfigure;\n% YOUR CODE HERE\n",
      "solution": "NEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/fmri_data.mat']);\n\nfnames = fieldnames(data);\nmax_numel = 0; fmri_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && numel(val) > max_numel\n    max_numel = numel(val); fmri_field = fnames{i};\n  end\nend\nfmri = data.(fmri_field);\n\nnd = ndims(fmri);\nif nd > 2\n  cx = round(size(fmri,1)/2);\n  cy = round(size(fmri,2)/2);\n  cz = round(size(fmri,3)/2);\n  ts = squeeze(fmri(cx, cy, cz, :))';\n  disp(['Extracted from center voxel: [' num2str(cx) ',' num2str(cy) ',' num2str(cz) ']']);\nelse\n  [r, c] = size(fmri);\n  if r < c\n    ts = fmri(1, :);\n  else\n    ts = fmri(:, 1)';\n  end\n  disp(['Extracted first row/column, length: ' num2str(length(ts))]);\nend\n\nif length(ts) > 500\n  ts = ts(1:500);\nend\n\nts_mean = mean(ts);\npsc = (ts - ts_mean) / ts_mean * 100;\n\nfigure;\n\nsubplot(2,1,1);\nplot(ts, 'b-', 'LineWidth', 1);\nxlabel('Time Point');\nylabel('Signal (a.u.)');\ntitle('Raw fMRI Time Series');\n\nsubplot(2,1,2);\nplot(psc, 'r-', 'LineWidth', 1);\nhold on;\nplot([1 length(psc)], [0 0], 'k--');\nhold off;\nxlabel('Time Point');\nylabel('% Change');\ntitle('Percent Signal Change');\n\nsgtitle('fMRI ROI Time Series');",
      "hints": [
        "For 4D data: squeeze(fmri(cx,cy,cz,:)) extracts the time series at a single voxel. squeeze removes singleton dimensions.",
        "Percent signal change: psc = (ts - mean(ts)) / mean(ts) * 100",
        "Add a horizontal dashed line at 0 to the PSC plot: plot([1 length(psc)], [0 0], 'k--')"
      ],
      "test_cases": [],
      "requires_plot": true
    },
    {
      "order_num": 3,
      "title": "Correlate fMRI signal with task design",
      "prompt": "Create a simple block-design task regressor and correlate it with the fMRI time series.\n\n1. Load fmri_data.mat, extract a time series (same approach as Exercise 2, use first 200 points or less)\n2. Create a block-design regressor: alternating blocks of 20 time points ON (1) and 20 OFF (0) for the full length of the time series. Use repmat or a loop.\n3. Compute the correlation between the time series (percent signal change) and the task regressor using corrcoef()\n4. Create a figure with 3 subplots (3×1):\n   - Top: the task regressor (step function). Title: 'Task Design (Block Design)'. ylabel: 'Task ON/OFF'\n   - Middle: percent signal change of the time series. Title: 'fMRI Percent Signal Change'. ylabel: '% Change'\n   - Bottom: overlay both (normalized to same scale). Title: ['Correlation: r = ' num2str(r, '%.3f')]. ylabel: 'Normalized'\n5. Main title: 'fMRI Task Correlation Analysis'\n6. Display: disp(['Correlation with task: r = ' num2str(r, '%.3f')])",
      "starter_code": "% Correlate fMRI signal with task design\nNEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/fmri_data.mat']);\n\n% Extract time series (reuse approach from Ex 2)\nfnames = fieldnames(data);\nmax_numel = 0; fmri_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && numel(val) > max_numel\n    max_numel = numel(val); fmri_field = fnames{i};\n  end\nend\nfmri = data.(fmri_field);\n\n% Extract time series\n% YOUR CODE HERE\n\n% Limit to 200 points\n% YOUR CODE HERE\n\n% Compute percent signal change\n% YOUR CODE HERE\n\n% Create block-design regressor\n% YOUR CODE HERE\n\n% Compute correlation\n% YOUR CODE HERE\n\n% Plot\nfigure;\n% YOUR CODE HERE\n",
      "solution": "NEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/fmri_data.mat']);\n\nfnames = fieldnames(data);\nmax_numel = 0; fmri_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && numel(val) > max_numel\n    max_numel = numel(val); fmri_field = fnames{i};\n  end\nend\nfmri = data.(fmri_field);\n\nnd = ndims(fmri);\nif nd > 2\n  cx = round(size(fmri,1)/2);\n  cy = round(size(fmri,2)/2);\n  cz = round(size(fmri,3)/2);\n  ts = squeeze(fmri(cx, cy, cz, :))';\nelse\n  [r, c] = size(fmri);\n  if r < c\n    ts = fmri(1, :);\n  else\n    ts = fmri(:, 1)';\n  end\nend\n\nif length(ts) > 200\n  ts = ts(1:200);\nend\nN = length(ts);\n\npsc = (ts - mean(ts)) / mean(ts) * 100;\n\nblock_length = 20;\none_cycle = [ones(1, block_length), zeros(1, block_length)];\nnum_cycles = ceil(N / (2 * block_length));\ntask = repmat(one_cycle, 1, num_cycles);\ntask = task(1:N);\n\nR = corrcoef(psc, task);\nr = R(1, 2);\ndisp(['Correlation with task: r = ' num2str(r, '%.3f')]);\n\nfigure;\n\nsubplot(3,1,1);\nplot(task, 'k-', 'LineWidth', 1.5);\nylim([-0.2 1.3]);\nxlabel('Time Point');\nylabel('Task ON/OFF');\ntitle('Task Design (Block Design)');\n\nsubplot(3,1,2);\nplot(psc, 'b-', 'LineWidth', 1);\nxlabel('Time Point');\nylabel('% Change');\ntitle('fMRI Percent Signal Change');\n\nsubplot(3,1,3);\npsc_norm = (psc - min(psc)) / (max(psc) - min(psc));\nplot(psc_norm, 'b-', 'LineWidth', 1);\nhold on;\nplot(task, 'r-', 'LineWidth', 1.5);\nhold off;\nlegend('fMRI (normalized)', 'Task');\nxlabel('Time Point');\nylabel('Normalized');\ntitle(['Correlation: r = ' num2str(r, '%.3f')]);\n\nsgtitle('fMRI Task Correlation Analysis');",
      "hints": [
        "Create one cycle: one_cycle = [ones(1,20), zeros(1,20)]; then repmat and truncate to the right length.",
        "corrcoef(x, y) returns a 2×2 matrix; the correlation is at position (1,2) or (2,1).",
        "Normalize for overlay: psc_norm = (psc - min(psc)) / (max(psc) - min(psc))"
      ],
      "test_cases": [],
      "requires_plot": true
    }
  ]
}
