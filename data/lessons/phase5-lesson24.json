{
  "phase": 5,
  "order_num": 4,
  "title": "Calcium Imaging: Watching Neurons Fire",
  "description": "Load real two-photon calcium imaging data, extract fluorescence traces, and detect neural activity events.",
  "difficulty": "advanced",
  "estimated_minutes": 45,
  "content_md": "# Calcium Imaging: Watching Neurons Fire\n\nCalcium imaging is one of the most exciting techniques in modern neuroscience. It lets you literally **watch hundreds of neurons fire in real time** under a microscope.\n\n## How Calcium Imaging Works\n\n1. Neurons are loaded with a **calcium indicator** — a molecule that fluoresces (glows) when calcium is present\n2. When a neuron fires an action potential, calcium floods into the cell\n3. A **two-photon microscope** captures images of the glowing neurons at ~30 frames/second\n4. Brighter = more calcium = more neural activity\n\n## Why It Matters\n\nCalcium imaging can record from **hundreds to thousands of neurons simultaneously** with single-cell resolution. Compare this to:\n- EEG: millions of neurons, no single-cell resolution\n- Single electrodes: one neuron at a time\n- Utah arrays: ~100 neurons\n\n## The Dataset\n\nThe file `calcium_data.mat` contains calcium imaging data. This typically includes:\n- Fluorescence traces: intensity over time for each identified neuron (ROI)\n- Possibly the raw imaging frames\n- Frame rate information\n\n## Key Concepts\n\n### dF/F (Delta F over F)\nRaw fluorescence values are not directly comparable between neurons (some are brighter than others). We normalize using **dF/F**:\n\n```matlab\nF0 = mean(F);          % baseline fluorescence\ndF_F = (F - F0) / F0;  % normalized change\n```\n\nA dF/F of 0.5 means the fluorescence increased by 50% above baseline.\n\n### Calcium Transients\nWhen a neuron fires, the calcium signal rises sharply and decays slowly (over ~0.5-2 seconds). These events are called **calcium transients**. We can detect them by thresholding the dF/F signal.\n\nLet's analyze some real calcium data!",
  "exercises": [
    {
      "order_num": 1,
      "title": "Load and inspect calcium imaging data",
      "prompt": "Load the calcium imaging dataset and explore its contents.\n\n1. Load calcium_data.mat\n2. Display all field names with their class and size\n3. Find all numeric fields and sort them by number of elements (largest first)\n4. For the top 3 largest numeric fields, display:\n   - Field name, size, min, max, and mean\n5. Try to identify which field is likely the fluorescence trace data:\n   - It should be 2D (neurons × time or time × neurons)\n   - Display: 'Likely fluorescence data: [field] with [N] neurons and [T] timepoints'",
      "starter_code": "% Load and inspect calcium imaging data\nNEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/calcium_data.mat']);\n\n% Display all fields\nfnames = fieldnames(data);\n% YOUR CODE HERE\n\n% Find and rank numeric fields by size\n% YOUR CODE HERE\n\n% Identify fluorescence data\n% YOUR CODE HERE\n",
      "solution": "NEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/calcium_data.mat']);\n\nfnames = fieldnames(data);\ndisp('=== Calcium Imaging Data Structure ===');\nfor i = 1:length(fnames)\n  name = fnames{i};\n  val = data.(name);\n  disp([name ' | class: ' class(val) ' | size: ' num2str(size(val))]);\nend\n\ndisp('');\ndisp('=== Numeric Fields (sorted by size) ===');\nnum_fields = {};\nnum_sizes = [];\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val)\n    num_fields{end+1} = fnames{i};\n    num_sizes(end+1) = numel(val);\n  end\nend\n\n[~, sort_idx] = sort(num_sizes, 'descend');\nfor j = 1:min(3, length(sort_idx))\n  idx = sort_idx(j);\n  name = num_fields{idx};\n  val = data.(name);\n  disp([name ' | size: ' num2str(size(val)) ...\n    ' | min: ' num2str(min(val(:))) ...\n    ' | max: ' num2str(max(val(:))) ...\n    ' | mean: ' num2str(mean(val(:)))]);\nend\n\ndisp('');\ndisp('=== Identifying Fluorescence Data ===');\nfor j = 1:length(sort_idx)\n  idx = sort_idx(j);\n  name = num_fields{idx};\n  val = data.(name);\n  if ndims(val) == 2 && min(size(val)) > 1\n    [r, c] = size(val);\n    if r < c\n      disp(['Likely fluorescence data: ' name ' with ' num2str(r) ' neurons and ' num2str(c) ' timepoints']);\n    else\n      disp(['Likely fluorescence data: ' name ' with ' num2str(c) ' neurons and ' num2str(r) ' timepoints']);\n    end\n    break;\n  end\nend",
      "hints": [
        "Store field names and their numel() values, then sort with [~, idx] = sort(sizes, 'descend').",
        "The fluorescence data is usually a 2D matrix where one dimension is neurons and the other is time.",
        "If rows < columns, rows are likely neurons; if columns < rows, columns are likely neurons."
      ],
      "test_cases": [],
      "requires_plot": false
    },
    {
      "order_num": 2,
      "title": "Compute dF/F and visualize traces",
      "prompt": "Extract fluorescence traces and compute the normalized dF/F signal.\n\n1. Load calcium_data.mat\n2. Find the main fluorescence matrix (largest 2D numeric field)\n3. Orient it so neurons are rows and time is columns\n4. Select the first 5 neurons (or fewer if less available): num_neurons = min(5, size(traces,1))\n5. For each neuron, compute dF/F:\n   - F0 = mean of the trace (baseline)\n   - dF_F = (F - F0) / F0\n6. Create a figure with 2 subplots (stacked):\n   - Top: plot raw fluorescence traces for the selected neurons (offset vertically for visibility). Title: 'Raw Fluorescence Traces'. ylabel: 'Fluorescence (offset)'\n   - Bottom: plot dF/F traces (also offset). Title: 'Normalized dF/F Traces'. ylabel: 'dF/F (offset)'\n   - Both: xlabel: 'Frame Number'\n7. Add a legend showing neuron numbers\n8. Main title: 'Calcium Imaging: Fluorescence Traces'",
      "starter_code": "% Compute dF/F from calcium imaging data\nNEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/calcium_data.mat']);\n\n% Find fluorescence matrix\nfnames = fieldnames(data);\nmax_numel = 0; ca_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && ndims(val) == 2 && min(size(val)) > 1 && numel(val) > max_numel\n    max_numel = numel(val); ca_field = fnames{i};\n  end\nend\n\ntraces = data.(ca_field);\n[r, c] = size(traces);\nif r > c\n  traces = traces';  % ensure neurons are rows\nend\n\nnum_neurons = min(5, size(traces, 1));\ndisp(['Analyzing ' num2str(num_neurons) ' neurons, ' num2str(size(traces,2)) ' timepoints']);\n\n% Compute dF/F for selected neurons\n% YOUR CODE HERE\n\n% Plot\nfigure;\n% YOUR CODE HERE\n",
      "solution": "NEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/calcium_data.mat']);\n\nfnames = fieldnames(data);\nmax_numel = 0; ca_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && ndims(val) == 2 && min(size(val)) > 1 && numel(val) > max_numel\n    max_numel = numel(val); ca_field = fnames{i};\n  end\nend\n\ntraces = data.(ca_field);\n[r, c] = size(traces);\nif r > c\n  traces = traces';\nend\n\nnum_neurons = min(5, size(traces, 1));\nnum_frames = size(traces, 2);\ndisp(['Analyzing ' num2str(num_neurons) ' neurons, ' num2str(num_frames) ' timepoints']);\n\ndff = zeros(num_neurons, num_frames);\nfor n = 1:num_neurons\n  F = traces(n, :);\n  F0 = mean(F);\n  dff(n, :) = (F - F0) / F0;\nend\n\nfigure;\n\nsubplot(2,1,1);\nhold on;\nleg_labels = {};\nfor n = 1:num_neurons\n  offset = (n-1) * (max(traces(n,:)) - min(traces(n,:))) * 1.2;\n  plot(traces(n,:) + offset, 'LineWidth', 0.8);\n  leg_labels{n} = ['Neuron ' num2str(n)];\nend\nhold off;\nxlabel('Frame Number');\nylabel('Fluorescence (offset)');\ntitle('Raw Fluorescence Traces');\nlegend(leg_labels);\n\nsubplot(2,1,2);\nhold on;\nfor n = 1:num_neurons\n  offset = (n-1) * 2;\n  plot(dff(n,:) + offset, 'LineWidth', 0.8);\nend\nhold off;\nxlabel('Frame Number');\nylabel('dF/F (offset)');\ntitle('Normalized dF/F Traces');\nlegend(leg_labels);\n\nsgtitle('Calcium Imaging: Fluorescence Traces');",
      "hints": [
        "dF/F for each neuron: F0 = mean(traces(n,:)); dff(n,:) = (traces(n,:) - F0) / F0;",
        "Offset traces vertically: plot(trace + offset) where offset = (n-1) * spacing.",
        "Use hold on to plot multiple traces on the same axes."
      ],
      "test_cases": [],
      "requires_plot": true
    },
    {
      "order_num": 3,
      "title": "Detect calcium transients",
      "prompt": "Detect calcium transient events in the dF/F traces using thresholding.\n\n1. Load calcium_data.mat, extract traces, orient as neurons×time\n2. Compute dF/F for the first neuron only\n3. Detect transients: find time points where dF/F exceeds 2 standard deviations above the mean\n   - threshold = mean(dff) + 2 * std(dff)\n   - transient_mask = dff > threshold\n4. Count the number of threshold crossings (rising edges):\n   - rising_edges = diff(transient_mask) == 1\n   - num_events = sum(rising_edges)\n5. Display: disp(['Threshold: ' num2str(threshold, '%.3f')])\n   disp(['Detected events: ' num2str(num_events)])\n6. Create a figure with 2 subplots:\n   - Top: dF/F trace with horizontal line at threshold and dots at detected event onsets. Title: 'Calcium Transient Detection (Neuron 1)'. ylabel: 'dF/F'\n   - Bottom: zoom into the first 500 frames (or less) showing the same. Title: 'Zoomed View (first 500 frames)'. ylabel: 'dF/F'\n   - Both: xlabel: 'Frame Number'\n7. Main title: 'Calcium Transient Detection'",
      "starter_code": "% Detect calcium transients\nNEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/calcium_data.mat']);\n\n% Find fluorescence matrix\nfnames = fieldnames(data);\nmax_numel = 0; ca_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && ndims(val) == 2 && min(size(val)) > 1 && numel(val) > max_numel\n    max_numel = numel(val); ca_field = fnames{i};\n  end\nend\ntraces = data.(ca_field);\n[r, c] = size(traces);\nif r > c, traces = traces'; end\n\n% Compute dF/F for neuron 1\nF = traces(1, :);\nF0 = mean(F);\ndff = (F - F0) / F0;\n\n% Detect transients\n% YOUR CODE HERE\n\n% Count events\n% YOUR CODE HERE\n\n% Display results\n% YOUR CODE HERE\n\n% Plot\nfigure;\n% YOUR CODE HERE\n",
      "solution": "NEURO_DATA = '/usr/share/neuroscience-data';\ndata = load([NEURO_DATA '/calcium_data.mat']);\n\nfnames = fieldnames(data);\nmax_numel = 0; ca_field = '';\nfor i = 1:length(fnames)\n  val = data.(fnames{i});\n  if isnumeric(val) && ndims(val) == 2 && min(size(val)) > 1 && numel(val) > max_numel\n    max_numel = numel(val); ca_field = fnames{i};\n  end\nend\ntraces = data.(ca_field);\n[r, c] = size(traces);\nif r > c, traces = traces'; end\n\nF = traces(1, :);\nF0 = mean(F);\ndff = (F - F0) / F0;\n\nthreshold = mean(dff) + 2 * std(dff);\ntransient_mask = dff > threshold;\n\nrising_edges = diff([0 transient_mask]) == 1;\nevent_onsets = find(rising_edges);\nnum_events = length(event_onsets);\n\ndisp(['Threshold: ' num2str(threshold, '%.3f')]);\ndisp(['Detected events: ' num2str(num_events)]);\n\nframes = 1:length(dff);\n\nfigure;\n\nsubplot(2,1,1);\nplot(frames, dff, 'b-', 'LineWidth', 0.8);\nhold on;\nplot([1 length(dff)], [threshold threshold], 'r--', 'LineWidth', 1.5);\nif num_events > 0\n  plot(event_onsets, dff(event_onsets), 'rv', 'MarkerSize', 6, 'MarkerFaceColor', 'r');\nend\nhold off;\nxlabel('Frame Number');\nylabel('dF/F');\ntitle('Calcium Transient Detection (Neuron 1)');\nlegend('dF/F', 'Threshold', 'Events');\n\nzoom_end = min(500, length(dff));\nsubplot(2,1,2);\nplot(frames(1:zoom_end), dff(1:zoom_end), 'b-', 'LineWidth', 0.8);\nhold on;\nplot([1 zoom_end], [threshold threshold], 'r--', 'LineWidth', 1.5);\nzoom_events = event_onsets(event_onsets <= zoom_end);\nif ~isempty(zoom_events)\n  plot(zoom_events, dff(zoom_events), 'rv', 'MarkerSize', 8, 'MarkerFaceColor', 'r');\nend\nhold off;\nxlabel('Frame Number');\nylabel('dF/F');\ntitle('Zoomed View (first 500 frames)');\n\nsgtitle('Calcium Transient Detection');",
      "hints": [
        "Threshold: threshold = mean(dff) + 2*std(dff). Mask: transient_mask = dff > threshold.",
        "Rising edges: diff([0 transient_mask]) == 1 — prepend 0 to catch events at frame 1.",
        "Plot event markers: plot(event_onsets, dff(event_onsets), 'rv', 'MarkerFaceColor', 'r')"
      ],
      "test_cases": [],
      "requires_plot": true
    }
  ]
}
