{
  "phase": 4,
  "order_num": 3,
  "title": "EEG Processing",
  "description": "Learn the essential EEG preprocessing steps — referencing, artifact detection, and extracting event-related potentials.",
  "difficulty": "advanced",
  "estimated_minutes": 45,
  "content_md": "# EEG Processing\n\nEEG (electroencephalography) records tiny electrical voltages from the scalp using an array of electrodes. Before you can analyze brain waves, the raw data needs **preprocessing**. This lesson covers the essential steps.\n\nThese are the exact techniques your friend would use before analyzing meditation EEG data.\n\n## The EEG Preprocessing Pipeline\n\nA typical pipeline looks like this:\n\n1. **Load data** (or in our case, simulate it)\n2. **Re-reference** — choose a reference scheme\n3. **Filter** — bandpass filter to remove drift and high-frequency noise\n4. **Artifact rejection** — remove or fix segments contaminated by blinks, muscle movement, etc.\n5. **Epoch** — cut continuous data into segments around events\n6. **Average** — compute the event-related potential (ERP)\n\n## Re-referencing\n\nEEG measures **voltage differences**. Every electrode is measured relative to a reference electrode (often on the mastoid or earlobe). But the choice of reference affects your results!\n\nThe **average reference** is a common choice: subtract the mean across all channels at each time point.\n\n```matlab\n% Average reference\n% eeg_data is channels x time_points\navg_ref = mean(eeg_data, 1);           % mean across channels (row vector)\neeg_reref = eeg_data - avg_ref;         % subtract from each channel\n```\n\nAfter average referencing, the sum of all channels at each time point is zero.\n\n## Artifact Detection\n\nArtifacts are non-brain signals that contaminate EEG:\n- **Eye blinks:** huge voltage spikes (50-200 uV) in frontal channels\n- **Muscle activity:** high-frequency noise from jaw clenching, etc.\n- **Electrode pops:** sudden jumps in a single channel\n\nThe simplest detection method: **threshold-based rejection**\n\n```matlab\n% If any channel exceeds +/- 100 uV, mark that time point as artifact\nthreshold = 100;  % microvolts\nartifact_mask = any(abs(eeg_data) > threshold, 1);  % 1 x time_points logical\n```\n\n## Event-Related Potentials (ERPs)\n\nAn ERP is the brain's response to a specific event (a sound, a visual stimulus, the beginning of a meditation period). To extract it:\n\n1. Cut the continuous EEG into **epochs** around each event\n2. (Optionally reject epochs with artifacts)\n3. **Average** across epochs — the noise cancels out, the signal remains\n\n```matlab\n% Pseudocode for epoching\nepoch_duration = 1.0;  % seconds\nfor i = 1:num_events\n  start_sample = event_samples(i);\n  end_sample = start_sample + epoch_duration * fs - 1;\n  epochs(:,:,i) = eeg_data(:, start_sample:end_sample);\nend\n\n% Average across epochs (dimension 3)\nERP = mean(epochs, 3);\n```\n\nThe power of averaging: if you have 100 trials, the noise is reduced by a factor of sqrt(100) = 10, while the consistent signal stays.\n\n## Baseline Correction\n\nBefore averaging, it is standard to subtract the **baseline** (a short pre-stimulus period) from each epoch:\n\n```matlab\nbaseline_samples = 1:round(0.2 * fs);  % first 200 ms\nfor i = 1:num_events\n  baseline_mean = mean(epochs(:, baseline_samples, i), 2);\n  epochs(:,:,i) = epochs(:,:,i) - baseline_mean;\nend\n```\n\nThis removes slow voltage drifts and ensures each epoch starts near zero.\n\nLet's implement these steps in the exercises.",
  "exercises": [
    {
      "order_num": 1,
      "title": "Average reference multi-channel EEG",
      "prompt": "Simulate a 4-channel EEG recording and apply average referencing.\n\nSteps:\n1. Use rand(\"state\", 50); randn(\"state\", 50). Set fs = 256, duration = 2 seconds.\n2. Create a time vector.\n3. Simulate 4 channels of EEG (channels x time_points matrix):\n   - Channel 1: 15*sin(2*pi*10*t) + 3*randn\n   - Channel 2: 10*sin(2*pi*10*t) + 5*sin(2*pi*20*t) + 3*randn\n   - Channel 3: 8*sin(2*pi*10*t) + 3*randn\n   - Channel 4: 12*sin(2*pi*10*t) + 7*sin(2*pi*6*t) + 3*randn\n4. Compute the average reference (mean across channels at each time point)\n5. Subtract the average reference from each channel\n6. Verify: display the mean across channels of the re-referenced data at time point 100 (should be ~0)\n\nDisplay: the size of the EEG matrix, the mean of the original data at time point 100 (rounded to 2 decimals), and the mean of the re-referenced data at time point 100 (rounded to 10 decimal places, displayed with format).",
      "starter_code": "% Average referencing of simulated EEG\nrand(\"state\", 50); randn(\"state\", 50);\n\nfs = 256;\nduration = 2;\nt = 0:1/fs:duration-1/fs;\nnum_samples = length(t);\n\n% Simulate 4 channels\n% YOUR CODE HERE\n\n% Compute average reference\n% YOUR CODE HERE\n\n% Apply average reference\n% YOUR CODE HERE\n\n% Display results\n% YOUR CODE HERE\n",
      "solution": "rand(\"state\", 50); randn(\"state\", 50);\n\nfs = 256;\nduration = 2;\nt = 0:1/fs:duration-1/fs;\nnum_samples = length(t);\n\neeg_data = zeros(4, num_samples);\neeg_data(1,:) = 15*sin(2*pi*10*t) + 3*randn(1, num_samples);\neeg_data(2,:) = 10*sin(2*pi*10*t) + 5*sin(2*pi*20*t) + 3*randn(1, num_samples);\neeg_data(3,:) = 8*sin(2*pi*10*t) + 3*randn(1, num_samples);\neeg_data(4,:) = 12*sin(2*pi*10*t) + 7*sin(2*pi*6*t) + 3*randn(1, num_samples);\n\navg_ref = mean(eeg_data, 1);\n\neeg_reref = eeg_data - avg_ref;\n\ndisp(['EEG matrix size: ' num2str(size(eeg_data,1)) ' x ' num2str(size(eeg_data,2))]);\ndisp(['Mean at time point 100 (original): ' num2str(round(mean(eeg_data(:,100))*100)/100)]);\ndisp(['Mean at time point 100 (re-referenced): ' num2str(round(mean(eeg_reref(:,100))))]);",
      "hints": [
        "Build the EEG matrix row by row: eeg_data = zeros(4, num_samples); eeg_data(1,:) = 15*sin(2*pi*10*t) + 3*randn(1, num_samples); and so on for each channel.",
        "Average reference: avg_ref = mean(eeg_data, 1); This takes the mean across rows (channels) at each time point. Then eeg_reref = eeg_data - avg_ref;",
        "To verify: mean(eeg_reref(:,100)) should be 0 (or very close). Display using disp(['Mean at time point 100 (re-referenced): ' num2str(mean(eeg_reref(:,100)))]);"
      ],
      "test_cases": [
        {
          "expected_output": "EEG matrix size: 4 x 512\nMean at time point 100 (original): -9.21\nMean at time point 100 (re-referenced): 0\n"
        }
      ],
      "requires_plot": false
    },
    {
      "order_num": 2,
      "title": "Detect and remove artifacts",
      "prompt": "Simulate a single-channel EEG signal with embedded artifacts, then detect and clean them.\n\nSteps:\n1. Use rand(\"state\", 77); randn(\"state\", 77). Set fs = 256, duration = 5 seconds.\n2. Create a clean EEG signal: 12*sin(2*pi*10*t) + 4*randn\n3. Insert 3 blink artifacts: At time indices 300-310, 700-710, and 1100-1110, add 150 uV to simulate blinks\n4. Detect artifacts: find all indices where abs(signal) > 80 uV\n5. Clean the signal: replace artifact samples with 0 (simple zeroing approach)\n6. Display: number of artifact samples detected, percentage of data that is artifact (rounded to 2 decimals), max absolute value of cleaned signal (rounded to 1 decimal)\n",
      "starter_code": "% Artifact detection and removal\nrand(\"state\", 77); randn(\"state\", 77);\n\nfs = 256;\nduration = 5;\nt = 0:1/fs:duration-1/fs;\n\n% Create clean EEG\nclean_eeg = 12*sin(2*pi*10*t) + 4*randn(1, length(t));\n\n% Add blink artifacts\neeg_with_artifacts = clean_eeg;\n% YOUR CODE HERE - add 150 uV at indices 300-310, 700-710, 1100-1110\n\n% Detect artifacts (threshold = 80 uV)\nthreshold = 80;\n% YOUR CODE HERE\n\n% Clean by zeroing artifact samples\ncleaned_eeg = eeg_with_artifacts;\n% YOUR CODE HERE\n\n% Display results\n% YOUR CODE HERE\n",
      "solution": "rand(\"state\", 77); randn(\"state\", 77);\n\nfs = 256;\nduration = 5;\nt = 0:1/fs:duration-1/fs;\n\nclean_eeg = 12*sin(2*pi*10*t) + 4*randn(1, length(t));\n\neeg_with_artifacts = clean_eeg;\neeg_with_artifacts(300:310) = eeg_with_artifacts(300:310) + 150;\neeg_with_artifacts(700:710) = eeg_with_artifacts(700:710) + 150;\neeg_with_artifacts(1100:1110) = eeg_with_artifacts(1100:1110) + 150;\n\nthreshold = 80;\nartifact_idx = find(abs(eeg_with_artifacts) > threshold);\nnum_artifacts = length(artifact_idx);\n\ncleaned_eeg = eeg_with_artifacts;\ncleaned_eeg(artifact_idx) = 0;\n\npct_artifact = num_artifacts / length(eeg_with_artifacts) * 100;\n\ndisp(['Artifact samples detected: ' num2str(num_artifacts)]);\ndisp(['Percentage artifact: ' num2str(round(pct_artifact*100)/100) '%']);\ndisp(['Max absolute cleaned signal: ' num2str(round(max(abs(cleaned_eeg))*10)/10) ' uV']);",
      "hints": [
        "Add artifacts: eeg_with_artifacts(300:310) = eeg_with_artifacts(300:310) + 150; Repeat for the other two ranges.",
        "Detect: artifact_idx = find(abs(eeg_with_artifacts) > threshold); num_artifacts = length(artifact_idx); Clean: cleaned_eeg(artifact_idx) = 0;",
        "Percentage: pct_artifact = num_artifacts / length(eeg_with_artifacts) * 100; Max cleaned: max(abs(cleaned_eeg))."
      ],
      "test_cases": [
        {
          "expected_output": "Artifact samples detected: 33\nPercentage artifact: 2.58%\nMax absolute cleaned signal: 26 uV\n"
        }
      ],
      "requires_plot": false
    },
    {
      "order_num": 3,
      "title": "Extract an event-related potential (ERP)",
      "prompt": "Simulate a continuous EEG recording with repeated stimulus responses embedded in noise, then extract the ERP by averaging across trials.\n\nSteps:\n1. Use rand(\"state\", 99); randn(\"state\", 99). Set fs = 256, total_duration = 30 seconds.\n2. Generate continuous noise: 8*randn for the full duration.\n3. Create 20 events spaced every 1.2 seconds, starting at t = 0.5s. Event samples = round(event_times * fs) + 1.\n4. At each event, embed a response: a positive peak at 100ms post-event (sample offset = round(0.1*fs)) with amplitude 5 uV (add 5 at that single sample), and a negative dip at 200ms (offset = round(0.2*fs)) with amplitude -3 uV.\n5. Epoch: extract 0 to 0.5 seconds after each event (epoch_length = round(0.5*fs) samples). Store in a matrix epochs(num_events, epoch_length).\n6. Average across trials to get the ERP (mean across rows).\n7. Display: number of epochs, ERP value at 100ms post-stimulus (rounded to 2 decimals), ERP value at 200ms post-stimulus (rounded to 2 decimals).\n\nThe averaging should reveal the embedded peaks while reducing the noise.",
      "starter_code": "% ERP extraction\nrand(\"state\", 99); randn(\"state\", 99);\n\nfs = 256;\ntotal_duration = 30;\nt = 0:1/fs:total_duration-1/fs;\n\n% Generate continuous noisy signal\ncontinuous_eeg = 8 * randn(1, length(t));\n\n% Define event times (20 events, every 1.2s, starting at 0.5s)\nnum_events = 20;\nevent_times = 0.5 + (0:num_events-1) * 1.2;\nevent_samples = round(event_times * fs) + 1;\n\n% Embed responses at each event\n% YOUR CODE HERE\n\n% Epoch extraction (0 to 0.5s after each event)\nepoch_length = round(0.5 * fs);\nepochs = zeros(num_events, epoch_length);\n% YOUR CODE HERE\n\n% Compute ERP (average across trials)\n% YOUR CODE HERE\n\n% Display results\n% YOUR CODE HERE\n",
      "solution": "rand(\"state\", 99); randn(\"state\", 99);\n\nfs = 256;\ntotal_duration = 30;\nt = 0:1/fs:total_duration-1/fs;\n\ncontinuous_eeg = 8 * randn(1, length(t));\n\nnum_events = 20;\nevent_times = 0.5 + (0:num_events-1) * 1.2;\nevent_samples = round(event_times * fs) + 1;\n\nfor i = 1:num_events\n  peak_sample = event_samples(i) + round(0.1 * fs);\n  dip_sample = event_samples(i) + round(0.2 * fs);\n  continuous_eeg(peak_sample) = continuous_eeg(peak_sample) + 5;\n  continuous_eeg(dip_sample) = continuous_eeg(dip_sample) - 3;\nend\n\nepoch_length = round(0.5 * fs);\nepochs = zeros(num_events, epoch_length);\nfor i = 1:num_events\n  start_idx = event_samples(i);\n  end_idx = start_idx + epoch_length - 1;\n  epochs(i, :) = continuous_eeg(start_idx:end_idx);\nend\n\nERP = mean(epochs, 1);\n\nsample_100ms = round(0.1 * fs) + 1;\nsample_200ms = round(0.2 * fs) + 1;\n\ndisp(['Number of epochs: ' num2str(num_events)]);\ndisp(['ERP at 100ms: ' num2str(round(ERP(sample_100ms)*100)/100) ' uV']);\ndisp(['ERP at 200ms: ' num2str(round(ERP(sample_200ms)*100)/100) ' uV']);",
      "hints": [
        "For embedding: loop over events. peak_sample = event_samples(i) + round(0.1*fs); continuous_eeg(peak_sample) = continuous_eeg(peak_sample) + 5; Similarly for the dip at 0.2s.",
        "For epoching: loop over events. start_idx = event_samples(i); end_idx = start_idx + epoch_length - 1; epochs(i,:) = continuous_eeg(start_idx:end_idx);",
        "ERP = mean(epochs, 1); To read specific time points: sample_100ms = round(0.1*fs) + 1; disp(['ERP at 100ms: ' num2str(round(ERP(sample_100ms)*100)/100) ' uV']);"
      ],
      "test_cases": [
        {
          "expected_output": "Number of epochs: 20\nERP at 100ms: 5.54 uV\nERP at 200ms: -3.25 uV\n"
        }
      ],
      "requires_plot": false
    }
  ]
}
