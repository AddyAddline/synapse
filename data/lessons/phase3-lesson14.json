{
  "phase": 3,
  "order_num": 4,
  "title": "Spectral Analysis",
  "description": "Dive deeper into frequency analysis with power spectral density, band power calculations, and spectrograms — essential tools for studying how brain rhythms change over time.",
  "difficulty": "advanced",
  "estimated_minutes": 45,
  "content_md": "# Spectral Analysis\n\nIn the previous lesson, you learned how the FFT reveals which frequencies are present in a signal. Now we'll take it further with techniques that neuroscientists use every day: calculating **power in specific frequency bands**, comparing power between experimental conditions, and watching **how frequencies change over time** with spectrograms.\n\n## Power Spectral Density (PSD)\n\nThe **Power Spectral Density** tells you how power is distributed across frequencies. It's like the FFT power spectrum, but properly scaled so you can compare between signals of different lengths.\n\nHere's how to compute a basic PSD:\n\n```matlab\nFs = 256;\nN = length(signal);\nY = fft(signal);\nPSD = (abs(Y) .^ 2) / (N * Fs);    % Scale by N * Fs\nPSD(2:end-1) = 2 * PSD(2:end-1);    % Double non-DC, non-Nyquist components\n\nf = (0 : N-1) * (Fs / N);\nhalf = 1 : floor(N/2);\nplot(f(half), PSD(half));\nxlabel('Frequency (Hz)');\nylabel('Power/Hz');\n```\n\nThe key difference from the regular power spectrum: PSD is normalized so that the **area under the curve** equals the total signal power. This means you can integrate (sum) over a frequency range to get the power in that band.\n\n## Calculating Band Power\n\nThis is one of the most common operations in EEG research: **how much power is in the alpha band? The theta band?**\n\nThe idea is simple — sum up the PSD values in the frequency range you care about:\n\n```matlab\n% Define frequency bands\nalpha_range = [8, 13];   % Alpha: 8-13 Hz\n\n% Find which frequency bins fall in this range\nf = (0 : N-1) * (Fs / N);\nalpha_idx = find(f >= alpha_range(1) & f <= alpha_range(2));\n\n% Sum the power in those bins\nalpha_power = sum(PSD(alpha_idx));\n```\n\nThe `find()` function returns the indices where the condition is true — so `alpha_idx` contains the positions of all frequencies between 8 and 13 Hz.\n\n## Relative Band Power\n\nOften it's more meaningful to look at **relative** band power — what fraction of total power is in each band:\n\n```matlab\ntotal_power = sum(PSD(half));\nalpha_relative = alpha_power / total_power * 100;  % As a percentage\ndisp(['Alpha band contains ' num2str(alpha_relative) '% of total power']);\n```\n\nThis is useful because absolute power varies between people (thicker skulls attenuate the signal!), but relative power is more consistent.\n\n## Comparing Conditions\n\nA classic neuroscience experiment: compare brain activity between two conditions. For example, alpha power is known to **increase when you close your eyes** (the \"alpha blocking\" effect discovered in 1929!).\n\n```matlab\n% Simulated EEG: eyes open vs eyes closed\n% Eyes open: weak alpha\neyes_open = 0.5 * sin(2 * pi * 10 * t) + randn(size(t)) * 0.3;\n\n% Eyes closed: strong alpha\neyes_closed = 2.0 * sin(2 * pi * 10 * t) + randn(size(t)) * 0.3;\n\n% Compare alpha power between conditions\n% (Compute PSD for each, then sum in alpha band)\n```\n\nThis kind of comparison is at the heart of countless EEG studies — meditation vs. rest, healthy vs. patient, before treatment vs. after.\n\n## Spectrograms: Frequency Over Time\n\nThe FFT tells you which frequencies are in a signal, but not **when** they occur. A **spectrogram** solves this by breaking the signal into short overlapping windows and computing the FFT of each window.\n\nThink of it like this:\n- Chop the signal into short segments (e.g., 0.5 seconds each)\n- Compute the FFT of each segment\n- Stack the results side by side\n- The result shows frequency on the y-axis, time on the x-axis, and color = power\n\n```matlab\n% Manual spectrogram using windowed FFT\nwindow_size = 128;     % Samples per window\nstep_size = 64;        % Step between windows (50% overlap)\n\nnum_windows = floor((length(signal) - window_size) / step_size) + 1;\nspect = zeros(floor(window_size/2), num_windows);\n\nfor i = 1 : num_windows\n    start_idx = (i - 1) * step_size + 1;\n    segment = signal(start_idx : start_idx + window_size - 1);\n    Y = fft(segment);\n    spect(:, i) = (abs(Y(1:floor(window_size/2))) .^ 2) / window_size;\nend\n```\n\nSpectrograms are beautiful and informative — they can show you, for example, how alpha power builds up gradually as someone relaxes, or how theta bursts appear during memory encoding.\n\n## Windowing\n\nWhen computing the FFT of a short segment, the sharp edges of the segment can create artificial frequencies (called **spectral leakage**). We reduce this by applying a **window function** that smoothly tapers the edges to zero:\n\n```matlab\n% Hamming window — the most common choice\nw = 0.54 - 0.46 * cos(2 * pi * (0:window_size-1) / (window_size-1));\nwindowed_segment = segment .* w;\nY = fft(windowed_segment);\n```\n\nThe Hamming window is the default choice in most EEG toolboxes. It slightly reduces frequency resolution but greatly reduces leakage artifacts.\n\n## Practical Tips for Neuroscience\n\n1. **Always use a window** when computing spectrograms (Hamming is a safe default)\n2. **50% overlap** between windows is standard\n3. **Longer windows** = better frequency resolution but worse time resolution (a tradeoff!)\n4. **Log scale** often helps visualize power: `10 * log10(power)` converts to decibels (dB)\n5. **Relative band power** is more robust than absolute power for group comparisons\n\n## Summary\n\n- **PSD** (Power Spectral Density) is the properly scaled power spectrum\n- **Band power** is calculated by summing PSD values in a frequency range\n- **Relative band power** (percentage of total) is more robust for comparisons\n- **Spectrograms** show how frequencies change over time using windowed FFTs\n- **Window functions** (like Hamming) reduce spectral leakage artifacts\n- These are the core tools neuroscientists use to analyze EEG rhythms",
  "exercises": [
    {
      "order_num": 1,
      "title": "Calculate brain wave band powers",
      "prompt": "A simulated EEG signal contains delta, theta, alpha, and beta components. Calculate the power in each frequency band and visualize them as a bar chart.\n\n1. Define a helper function at the TOP:\n```\nfunction bp = band_power(psd, f, low_freq, high_freq)\n    idx = find(f >= low_freq & f <= high_freq);\n    bp = sum(psd(idx));\nend\n```\n\n2. Create a simulated EEG (Fs=256, 2 seconds):\n   - `delta_wave = 1.0 * sin(2*pi*2*t);`\n   - `theta_wave = 0.8 * sin(2*pi*6*t);`\n   - `alpha_wave = 2.0 * sin(2*pi*10*t);`  (strongest!)\n   - `beta_wave = 0.5 * sin(2*pi*20*t);`\n   - `eeg = delta_wave + theta_wave + alpha_wave + beta_wave;`\n\n3. Compute PSD:\n   - `Y = fft(eeg); N = length(eeg);`\n   - `psd = (abs(Y).^2) / (N * Fs);`\n   - `psd(2:end-1) = 2 * psd(2:end-1);`\n   - `f = (0:N-1) * (Fs/N);`\n\n4. Calculate power in each band using the helper function:\n   - Delta: 0.5-4 Hz, Theta: 4-8 Hz, Alpha: 8-13 Hz, Beta: 13-30 Hz\n\n5. Display which band has the most power using max() and a cell array of band names.\n\n6. Create a bar chart of the four band powers:\n   - `bar([delta_power, theta_power, alpha_power, beta_power])`\n   - `set(gca, 'XTickLabel', {'Delta', 'Theta', 'Alpha', 'Beta'})`\n   - `ylabel('Power')` and `title('EEG Band Power Distribution')`\n\nThe alpha bar should be clearly the tallest!",
      "starter_code": "% Define helper function at TOP\n\n% Main code\nFs = 256;\nt = 0 : 1/Fs : 2 - 1/Fs;\n\n% Create EEG components\n\n% Combine into EEG signal\n\n% Compute PSD\n\n% Calculate band powers\n\n% Display the dominant band name\n\n% Create bar chart of band powers\n",
      "solution": "function bp = band_power(psd, f, low_freq, high_freq)\n    idx = find(f >= low_freq & f <= high_freq);\n    bp = sum(psd(idx));\nend\n\nFs = 256;\nt = 0 : 1/Fs : 2 - 1/Fs;\ndelta_wave = 1.0 * sin(2 * pi * 2 * t);\ntheta_wave = 0.8 * sin(2 * pi * 6 * t);\nalpha_wave = 2.0 * sin(2 * pi * 10 * t);\nbeta_wave = 0.5 * sin(2 * pi * 20 * t);\neeg = delta_wave + theta_wave + alpha_wave + beta_wave;\nY = fft(eeg);\nN = length(eeg);\npsd = (abs(Y) .^ 2) / (N * Fs);\npsd(2:end-1) = 2 * psd(2:end-1);\nf = (0 : N-1) * (Fs / N);\ndelta_power = band_power(psd, f, 0.5, 4);\ntheta_power = band_power(psd, f, 4, 8);\nalpha_power = band_power(psd, f, 8, 13);\nbeta_power = band_power(psd, f, 13, 30);\npowers = [delta_power, theta_power, alpha_power, beta_power];\nbands = {'delta', 'theta', 'alpha', 'beta'};\n[max_val, max_idx] = max(powers);\ndisp(bands{max_idx})\nbar(powers);\nset(gca, 'XTickLabel', {'Delta', 'Theta', 'Alpha', 'Beta'});\nylabel('Power');\ntitle('EEG Band Power Distribution');",
      "hints": [
        "Put the band_power function at the very top. Then create the EEG: delta_wave=1.0*sin(2*pi*2*t); etc., and eeg = delta_wave + theta_wave + alpha_wave + beta_wave;",
        "Compute PSD: Y=fft(eeg); N=length(eeg); psd=(abs(Y).^2)/(N*Fs); psd(2:end-1)=2*psd(2:end-1); f=(0:N-1)*(Fs/N); Then call: delta_power = band_power(psd, f, 0.5, 4); and similarly for others.",
        "Store powers in a vector: powers = [delta_power, theta_power, alpha_power, beta_power]; bands = {'delta','theta','alpha','beta'}; [max_val, max_idx] = max(powers); disp(bands{max_idx}). Then bar(powers); set(gca, 'XTickLabel', {'Delta','Theta','Alpha','Beta'});"
      ],
      "test_cases": [
        {
          "expected_output": "alpha\n"
        }
      ],
      "requires_plot": true
    },
    {
      "order_num": 2,
      "title": "Compare alpha power: eyes open vs eyes closed",
      "prompt": "Simulate the classic \"alpha blocking\" experiment! When you close your eyes, alpha power increases dramatically.\n\n1. Define the `band_power` helper function at the TOP (same as before).\n\n2. Create two conditions (Fs=256, 2 seconds each, set seed with `randn('state', 42)`):\n   - **Eyes open**: weak alpha (amplitude 0.5) + noise\n     `eyes_open = 0.5 * sin(2*pi*10*t) + 0.3 * randn(size(t));`\n   - **Eyes closed**: strong alpha (amplitude 2.0) + same noise level\n     `eyes_closed = 2.0 * sin(2*pi*10*t) + 0.3 * randn(size(t));`\n\n3. Compute PSD for both signals\n\n4. Calculate alpha band power (8-13 Hz) for both conditions\n\n5. Plot the two PSDs overlaid on ONE plot (frequencies 0-40 Hz only):\n   - Use `plot(f(range), psd1(range), 'b', f(range), psd2(range), 'r')`\n   - Add a legend: `legend('Eyes Open', 'Eyes Closed')`\n   - Title: `title('Alpha Power: Eyes Open vs Closed')`\n   - `xlabel('Frequency (Hz)')` and `ylabel('Power/Hz')`",
      "starter_code": "% Define band_power function at TOP\n\n% Main code\nrandn('state', 42);\nFs = 256;\nt = 0 : 1/Fs : 2 - 1/Fs;\n\n% Create eyes open signal (weak alpha + noise)\n\n% Create eyes closed signal (strong alpha + noise)\n\n% Compute PSD for eyes open\n\n% Compute PSD for eyes closed\n\n% Calculate alpha power for both\n\n% Plot both PSDs (0-40 Hz range)\n\n% Add legend, title, axis labels\n",
      "solution": "function bp = band_power(psd, f, low_freq, high_freq)\n    idx = find(f >= low_freq & f <= high_freq);\n    bp = sum(psd(idx));\nend\n\nrandn('state', 42);\nFs = 256;\nt = 0 : 1/Fs : 2 - 1/Fs;\neyes_open = 0.5 * sin(2 * pi * 10 * t) + 0.3 * randn(size(t));\neyes_closed = 2.0 * sin(2 * pi * 10 * t) + 0.3 * randn(size(t));\nY1 = fft(eyes_open);\nN = length(eyes_open);\npsd1 = (abs(Y1) .^ 2) / (N * Fs);\npsd1(2:end-1) = 2 * psd1(2:end-1);\nY2 = fft(eyes_closed);\npsd2 = (abs(Y2) .^ 2) / (N * Fs);\npsd2(2:end-1) = 2 * psd2(2:end-1);\nf = (0 : N-1) * (Fs / N);\nalpha_open = band_power(psd1, f, 8, 13);\nalpha_closed = band_power(psd2, f, 8, 13);\nrange = find(f >= 0 & f <= 40);\nplot(f(range), psd1(range), 'b', f(range), psd2(range), 'r');\nlegend('Eyes Open', 'Eyes Closed');\ntitle('Alpha Power: Eyes Open vs Closed');\nxlabel('Frequency (Hz)');\nylabel('Power/Hz');",
      "hints": [
        "Create signals: eyes_open = 0.5*sin(2*pi*10*t) + 0.3*randn(size(t)); eyes_closed = 2.0*sin(2*pi*10*t) + 0.3*randn(size(t));",
        "Compute PSD for each: Y1 = fft(eyes_open); N = length(eyes_open); psd1 = (abs(Y1).^2)/(N*Fs); psd1(2:end-1) = 2*psd1(2:end-1); Repeat for eyes_closed.",
        "Plot with range: range = find(f >= 0 & f <= 40); plot(f(range), psd1(range), 'b', f(range), psd2(range), 'r'); legend('Eyes Open', 'Eyes Closed'); title('Alpha Power: Eyes Open vs Closed');"
      ],
      "test_cases": [],
      "requires_plot": true
    },
    {
      "order_num": 3,
      "title": "Create a basic spectrogram",
      "prompt": "Build a spectrogram to visualize how brain wave frequencies change over time!\n\nSimulate a 4-second EEG signal where the dominant rhythm CHANGES:\n- Seconds 0-2: strong alpha (10 Hz, amplitude 2) — person is relaxed\n- Seconds 2-4: strong beta (20 Hz, amplitude 2) — person starts concentrating\n\nThen create a spectrogram using windowed FFT.\n\n1. Create the changing signal:\n```\nFs = 256;\nt = 0 : 1/Fs : 4 - 1/Fs;\nsignal = zeros(size(t));\nsignal(t < 2) = 2 * sin(2 * pi * 10 * t(t < 2));\nsignal(t >= 2) = 2 * sin(2 * pi * 20 * t(t >= 2));\n```\n\n2. Compute the spectrogram with windowed FFT:\n```\nwindow_size = 128;\nstep_size = 32;\nnum_windows = floor((length(signal) - window_size) / step_size) + 1;\nhalf_win = floor(window_size / 2);\nspect = zeros(half_win, num_windows);\nhamming_win = 0.54 - 0.46 * cos(2 * pi * (0:window_size-1) / (window_size-1));\nfor i = 1 : num_windows\n    start_idx = (i - 1) * step_size + 1;\n    segment = signal(start_idx : start_idx + window_size - 1);\n    segment = segment .* hamming_win;\n    Y = fft(segment);\n    spect(:, i) = (abs(Y(1:half_win)) .^ 2) / window_size;\nend\n```\n\n3. Plot the spectrogram:\n```\nf_axis = (0 : half_win - 1) * (Fs / window_size);\nt_axis = ((0 : num_windows - 1) * step_size + window_size / 2) / Fs;\nimagesc(t_axis, f_axis, spect);\naxis('xy');\nylim([0 40]);\nxlabel('Time (s)');\nylabel('Frequency (Hz)');\ntitle('EEG Spectrogram: Relaxation to Concentration');\ncolorbar;\n```\n\nYou should see alpha (10 Hz) dominating in the first half and beta (20 Hz) in the second half!",
      "starter_code": "% Create a signal that changes from alpha to beta\nFs = 256;\nt = 0 : 1/Fs : 4 - 1/Fs;\n\n% First 2 seconds: alpha (10 Hz), Last 2 seconds: beta (20 Hz)\n\n% Compute spectrogram with windowed FFT\nwindow_size = 128;\nstep_size = 32;\n\n% Create Hamming window\n\n% Loop over windows, compute FFT of each\n\n% Plot the spectrogram using imagesc\n",
      "solution": "Fs = 256;\nt = 0 : 1/Fs : 4 - 1/Fs;\nsignal = zeros(size(t));\nsignal(t < 2) = 2 * sin(2 * pi * 10 * t(t < 2));\nsignal(t >= 2) = 2 * sin(2 * pi * 20 * t(t >= 2));\nwindow_size = 128;\nstep_size = 32;\nnum_windows = floor((length(signal) - window_size) / step_size) + 1;\nhalf_win = floor(window_size / 2);\nspect = zeros(half_win, num_windows);\nhamming_win = 0.54 - 0.46 * cos(2 * pi * (0:window_size-1) / (window_size-1));\nfor i = 1 : num_windows\n    start_idx = (i - 1) * step_size + 1;\n    segment = signal(start_idx : start_idx + window_size - 1);\n    segment = segment .* hamming_win;\n    Y = fft(segment);\n    spect(:, i) = (abs(Y(1:half_win)) .^ 2) / window_size;\nend\nf_axis = (0 : half_win - 1) * (Fs / window_size);\nt_axis = ((0 : num_windows - 1) * step_size + window_size / 2) / Fs;\nimagesc(t_axis, f_axis, spect);\naxis('xy');\nylim([0 40]);\nxlabel('Time (s)');\nylabel('Frequency (Hz)');\ntitle('EEG Spectrogram: Relaxation to Concentration');\ncolorbar;",
      "hints": [
        "Create the changing signal: signal = zeros(size(t)); signal(t < 2) = 2*sin(2*pi*10*t(t < 2)); signal(t >= 2) = 2*sin(2*pi*20*t(t >= 2));",
        "The spectrogram loop: for each window, extract a segment, multiply by Hamming window, compute FFT, store the power of the first half. num_windows = floor((length(signal)-window_size)/step_size)+1;",
        "Plot with imagesc(t_axis, f_axis, spect); axis('xy'); ylim([0 40]); The axis('xy') flips the y-axis so low frequencies are at the bottom. Add xlabel, ylabel, title, and colorbar."
      ],
      "test_cases": [],
      "requires_plot": true
    }
  ]
}
